

    <h3 style="text-align: center">Historical Province Boundaries</h3>

    <div id="maptab">
            <form style="text-align:center; font-weight:bold;" action="/explore/" method="get">

            {{ searchform.country.label }} {{ searchform.country }}
            {{ searchform.name.label }} {{ searchform.name }}

            <script>
            submitsearch = function() {
                    document.getElementById("searchbutton").click();
                }
            </script>
            
            <div style="padding:10px; display:inline-block;">
            <input id="searchbutton" type="submit" value="Search" style="background-color:orange; color:white; border-radius:10px; padding:7px; font-family:inherit; font-size:inherit; font-weight:bold; text-decoration:underline; margin:7px;">
            </div>

            </form>

	<div class="map header" style="text-align:center; margin-top: 0; padding: 0 0 0 0;">
            <input id="datetext" type="text" style="text-align:center; font-size:large; font-weight:bold; position:relative; z-index:1000; bottom:-40px; border: 3px solid black; border-radius: 7px;" oninput="update_slider(document.getElementById('datetext').value);"/>
	</div>

	<div id="mapcontainer" style="width:90%; margin-left:5%; height:60vh; padding:0 0 30px 0;">
            <div style="width:100%; height:100%; margins:auto;" id="map">
            </div>
	</div>

	<style>
            input[type=range] {
              -webkit-appearance: none;
              width: 100%;
              margin: 5.8px 0;
            }
            input[type=range]:focus {
              outline: none;
            }
            input[type=range]::-webkit-slider-runnable-track {
              width: 100%;
              height: 8.4px;
              cursor: pointer;
              box-shadow: 1px 1px 1px #000000, 0px 0px 1px #0d0d0d;
              background: rgb(200,200,200);
              border-radius: 1.3px;
              border: 0.2px solid #010101;
            }
            input[type=range]::-webkit-slider-thumb {
              box-shadow: 1px 1px 1px #000000, 0px 0px 1px #0d0d0d;
              border: 2.2px solid #000000;
              height: 20px;
              width: 50px;
              border-radius: 3px;
              background: #ffffff;
              cursor: pointer;
              -webkit-appearance: none;
              margin-top: -6px;
            }
            input[type=range]:focus::-webkit-slider-runnable-track {
              background: rgb(200,200,200);
            }
            input[type=range]::-moz-range-track {
              width: 100%;
              height: 8.4px;
              cursor: pointer;
              box-shadow: 1px 1px 1px #000000, 0px 0px 1px #0d0d0d;
              background: #6f6f6f;
              border-radius: 1.3px;
              border: 0.2px solid #010101;
            }
            input[type=range]::-moz-range-thumb {
              box-shadow: 1px 1px 1px #000000, 0px 0px 1px #0d0d0d;
              border: 2.2px solid #000000;
              height: 20px;
              width: 50px;
              border-radius: 3px;
              background: #ffffff;
              cursor: pointer;
            }
            input[type=range]::-ms-track {
              width: 100%;
              height: 8.4px;
              cursor: pointer;
              background: transparent;
              border-color: transparent;
              color: transparent;
            }
            input[type=range]::-ms-fill-lower {
              background: #626262;
              border: 0.2px solid #010101;
              border-radius: 2.6px;
              box-shadow: 1px 1px 1px #000000, 0px 0px 1px #0d0d0d;
            }
            input[type=range]::-ms-fill-upper {
              background: #6f6f6f;
              border: 0.2px solid #010101;
              border-radius: 2.6px;
              box-shadow: 1px 1px 1px #000000, 0px 0px 1px #0d0d0d;
            }
            input[type=range]::-ms-thumb {
              box-shadow: 1px 1px 1px #000000, 0px 0px 1px #0d0d0d;
              border: 2.2px solid #000000;
              height: 20px;
              width: 50px;
              border-radius: 3px;
              background: #ffffff;
              cursor: pointer;
              height: 8.4px;
            }
            input[type=range]:focus::-ms-fill-lower {
              background: #6f6f6f;
            }
            input[type=range]:focus::-ms-fill-upper {
              background: #7c7c7c;
            }
	</style>

	<script>
	function update_slider(date) {
                loaddata();
		// move slider
		curdate = new Date(date);
		mindate = new Date(1900, 1, 1);
		maxdate = new Date(2014, 12, 31);
		var daterange = maxdate.getTime() - mindate.getTime();
		var fraction = (curdate.getTime() - mindate.getTime()) / daterange;
		slider = document.getElementById('dateslider');
		slider.value = fraction;
	};
	</script>
	
	<div style="width:100%; text-align:center;">		
		<p style="font-weight:bold;">
		1900
		<input id="dateslider" type="range" style="width:70%; background-color:black" value="1" min="0" max="1" step="0.0000001" list="ticks" oninput="updatedate(this.value)" onchange="loaddata();"/>
		2015
		<datalist id="ticks">
		<option>1900</option>
		<option>1950</option>
		<option>2000</option>
		<option>2015</option>
		</datalist>
		</p>
	</div>
	
	<script>
	function updatedate(fraction) {
		mindate = new Date(1900, 1, 1);
		maxdate = new Date(2014, 12, 31);
		var daterange = maxdate.getTime() - mindate.getTime();
		var newdate = new Date(mindate.getTime() + (daterange * fraction) );
		datetext = document.getElementById("datetext");
		datetext.value = newdate.toISOString().slice(0,10);
	};
	updatedate(0.99); // max at default
	</script>
	
	
	
	
	<script src="http://openlayers.org/api/2.13/OpenLayers.js"></script>
	
	<script defer="defer">
	var map = new OpenLayers.Map('map');
	var wms = new OpenLayers.Layer.WMS( "OpenLayers WMS",
		"http://vmap0.tiles.osgeo.org/wms/vmap0", {layers: 'basic'} );
		
	var worldsat = new OpenLayers.Layer.WMS( "OpenLayers WMS",
		"http://www.gebco.net/data_and_products/gebco_web_services/web_map_service/mapserv?", {layers: 'GEBCO_LATEST'} );	
		
	var xyz = new OpenLayers.Layer.XYZ(
		"Dark XYZ",
		[
			"http://a.basemaps.cartocdn.com/dark_all/${z}/${x}/${y}.png",
			"http://b.basemaps.cartocdn.com/dark_all/${z}/${x}/${y}.png",
			"http://c.basemaps.cartocdn.com/dark_all/${z}/${x}/${y}.png",
			"http://d.basemaps.cartocdn.com/dark_all/${z}/${x}/${y}.png",
		], {
			sphericalMercator: true,
			wrapDateLine: false,
		}
	);
	
	var stamen = new OpenLayers.Layer.XYZ("Stamen",["http://tile.stamen.com/watercolor/${z}/${x}/${y}.jpg"]);
	
	map.addLayer(wms);
	map.zoomToMaxExtent();
	</script>

	<script>

	// empty province layer
	var style = new OpenLayers.Style({fillColor:"${getColor}", fillOpacity:0.5, strokeWidth:0.4, fontSize:12, label:"${getLabel}"}, //, labelOffsetX:"${getLabelOffsetX}", labelOffsetY:"${getLabelOffsetY}"},
										{context: {
												getLabel: function(feature) {
													if (map.zoom > 5) {
														return feature.attributes.name.toUpperCase();
													} else {
														return '';
													}
												},
												getColor: function(feature) {
													return document.countryColors[feature.attributes.country];
												},
												
												// not working yet
												/*
												getLabelOffsetX: function(feature) {
													var midpx = feature.geometry.getBounds().getCenterPixel().x;
													return 400 //midpx*100;
												},
												getLabelOffsetY: function(feature) {
													var midpy = feature.geometry.getBounds().getCenterPixel().y;
													return 400 //midpy*100;
												},
												*/
												
												// instead make a separate layer of polygon centroid and label those
												// ... 
											}
										});
	var provLayer = new OpenLayers.Layer.Vector("Provinces", {styleMap:style});
	map.addLayers([provLayer]);
	
	// how to render data
	renderdata = function(data) {
		var geojson_format = new OpenLayers.Format.GeoJSON();
		var geoj_str = JSON.stringify(data);
		document.allProvs = geojson_format.read(geoj_str, "FeatureCollection");
		var date = document.getElementById('datetext').value;
		draw_borders(date);
	};

	// initiate map
	onstartup = function(data) {
		var geojson_format = new OpenLayers.Format.GeoJSON();
		var geoj_str = JSON.stringify(data);
		document.allProvs = geojson_format.read(geoj_str, "FeatureCollection");
		var date = document.getElementById('datetext').value;
		draw_borders(date);
                map.zoomToExtent(provLayer.getDataExtent());
        };
        var date = document.getElementById('datetext').value;
        var year = date.split("-")[0]
        var month = date.split("-")[1]
        var day = date.split("-")[2]
        var datadict = Object.assign({}, {format:"json", simplify:0.2, year:year, month:month, day:day}, {{ getparams|safe }});
	$.getJSON("/api/", datadict, onstartup);

	// load data func
	function loaddata() {
                // load data with resolution based on zoomlevel
                var date = document.getElementById('datetext').value;
                var year = date.split("-")[0]
                var month = date.split("-")[1]
                var day = date.split("-")[2]

                var bbox = map.getExtent().toArray();

                var apiurl = "/api/";
                var datadict = Object.assign({}, {format:"json", bbox:bbox.join(','), year:year, month:month, day:day}, {{ getparams|safe }});
                if (map.zoom <= 3) {
                    datadict['simplify'] = 0.2;
                    $.getJSON(apiurl, datadict, renderdata);
                } else if (map.zoom <= 4) {
                    datadict['simplify'] = 0.1;
                    $.getJSON(apiurl, datadict, renderdata);
                } else if (map.zoom <= 5) {
                    datadict['simplify'] = 0.05;
                    $.getJSON(apiurl, datadict, renderdata);
                } else if (map.zoom <= 6) {
                    datadict['simplify'] = 0.025;
                    $.getJSON(apiurl, datadict, renderdata);
                } else {
                    $.getJSON(apiurl, datadict, renderdata);
                };
        };
	map.events.register("zoomend", map, loaddata);
	map.events.register("moveend", map, loaddata);

        // assign random colors to each country
        document.countryColors = {};
        
        function getRandomColor(){
                var color =  "#" + (Math.random() * 0xFFFFFF << 0).toString(16);
                return color;
        };

	// define drawing function
	function draw_borders(date) {
	
		// drop previous provs
		provLayer.removeAllFeatures();
		
		// select provs by date
		dateFeats = [];
		for (feat of document.allProvs) {
			var start = feat.attributes.start;
			var end = feat.attributes.end;
			if (start <= date && end > date ) {
				if ( ! (feat.attributes.country in document.countryColors)) {
					// assign random color for country
					document.countryColors[feat.attributes.country] = getRandomColor();
				};
				dateFeats.push(feat);
			};
		};
		
		// add to layer
		provLayer.addFeatures(dateFeats);
	};
	
	</script>

    </div>
